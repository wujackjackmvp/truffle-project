<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>InfoContract é“¾ä¸Šäº¤äº’</title>
    <style></style>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      }
      h1 {
        color: #667eea;
        text-align: center;
        margin-bottom: 30px;
      }
      .section {
        margin-bottom: 30px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
      }
      .section h2 {
        color: #764ba2;
        margin-bottom: 15px;
        font-size: 20px;
      }
      .form-group {
        margin-bottom: 15px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        color: #333;
        font-weight: bold;
      }
      input[type='text'],
      input[type='number'] {
        width: 100%;
        padding: 10px;
        border: 2px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
      }
      input:focus {
        outline: none;
        border-color: #667eea;
      }
      button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        transition: transform 0.2s;
        width: 100%;
      }
      button:hover {
        transform: translateY(-2px);
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
      }
      .info-box {
        background: white;
        padding: 15px;
        border-radius: 5px;
        margin-top: 10px;
      }
      .info-box p {
        margin: 5px 0;
        color: #333;
      }
      .status {
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 15px;
        text-align: center;
        font-weight: bold;
      }
      .status.success {
        background: #d4edda;
        color: #155724;
      }
      .status.error {
        background: #f8d7da;
        color: #721c24;
      }
      .status.info {
        background: #d1ecf1;
        color: #0c5460;
      }
      .hidden {
        display: none;
      }
      .contract-info {
        font-size: 12px;
        color: #666;
        word-break: break-all;
      }
      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-left: 10px;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .event-item {
        background: white;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 10px;
        border-left: 4px solid #667eea;
        animation: slideIn 0.3s ease-out;
      }
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateX(-20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }
      .event-item .event-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        font-weight: bold;
        color: #667eea;
      }
      .event-item .event-time {
        font-size: 12px;
        color: #999;
      }
      .event-item .event-data {
        color: #333;
        font-size: 14px;
        margin: 5px 0;
      }
      .event-item .event-block {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
      }
      .listening {
        animation: pulse 2s infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.6;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ“ InfoContract é“¾ä¸Šäº¤äº’</h1>

      <!-- çŠ¶æ€æ˜¾ç¤º -->
      <div id="status" class="status hidden"></div>

      <!-- è¿æ¥é’±åŒ… -->
       
      <div class="section">
        <h2>ğŸ”— è¿æ¥é’±åŒ…</h2>
        <button id="connectBtn">è¿æ¥ MetaMask</button>
        <div id="accountInfo" class="info-box hidden">
          <p><strong>è´¦æˆ·åœ°å€:</strong> <span id="accountAddress"></span></p>
          <p><strong>å½“å‰ç½‘ç»œ:</strong> <span id="networkName"></span></p>
          <p><strong>ä½™é¢:</strong> <span id="balance"></span> ETH</p>
        </div>
        <div id="networkSwitch" class="hidden" style="margin-top: 15px">
          <label style="display: block; margin-bottom: 5px">åˆ‡æ¢ç½‘ç»œ:</label>
          <select
            id="networkSelector"
            style="
              width: 100%;
              padding: 10px;
              border: 2px solid #ddd;
              border-radius: 5px;
              margin-bottom: 10px;
            "
          >
            <option value="">-- é€‰æ‹©ç½‘ç»œ --</option>
            <option value="0x539">æœ¬åœ°æµ‹è¯•ç½‘ (Ganache - 127.0.0.1:7545)</option>
            <option value="0x1">ä»¥å¤ªåŠä¸»ç½‘ (Mainnet)</option>
            <option value="0xaa36a7">Sepolia æµ‹è¯•ç½‘</option>
            <option value="0x5">Goerli æµ‹è¯•ç½‘</option>
            <option value="0x38">BSC ä¸»ç½‘</option>
            <option value="0x61">BSC æµ‹è¯•ç½‘</option>
            <option value="0x89">Polygon ä¸»ç½‘</option>
            <option value="0x13882">Polygon Amoy æµ‹è¯•ç½‘</option>
          </select>
          <button id="switchNetworkBtn" style="width: 100%">
            åˆ‡æ¢åˆ°é€‰ä¸­ç½‘ç»œ
          </button>
        </div>
      </div>

      <!-- è¯»å–æ“ä½œ -->
      <div class="section">
        <h2>ğŸ“– è¯»å–æ•°æ® (å…è´¹)</h2>
        <button id="sayHiBtn" style="margin-bottom: 10px">è°ƒç”¨ sayHi()</button>
        <button id="getInfoBtn">è°ƒç”¨ getInfo()</button>
        <div id="readResult" class="info-box hidden">
          <p id="readResultText"></p>
        </div>
      </div>

      <!-- å†™å…¥æ“ä½œ -->
      <div class="section">
        <h2>âœï¸ å†™å…¥æ•°æ® (éœ€è¦ Gas)</h2>
        <div class="form-group">
          <label for="nameInput">å§“å:</label>
          <input type="text" id="nameInput" placeholder="è¯·è¾“å…¥å§“å" />
        </div>
        <div class="form-group">
          <label for="ageInput">å¹´é¾„:</label>
          <input type="number" id="ageInput" placeholder="è¯·è¾“å…¥å¹´é¾„" />
        </div>
        <button id="setInfoBtn">è°ƒç”¨ setInfo()</button>
        <div id="txResult" class="info-box hidden">
          <p id="txResultText"></p>
        </div>
      </div>

      <!-- äº‹ä»¶ç›‘å¬ -->
      <div class="section">
        <h2>ğŸ“¡ äº‹ä»¶ç›‘å¬</h2>
        <div style="display: flex; gap: 10px; margin-bottom: 15px">
          <button id="startListenBtn" style="flex: 1">å¼€å§‹ç›‘å¬</button>
          <button id="stopListenBtn" style="flex: 1; background: #dc3545">
            åœæ­¢ç›‘å¬
          </button>
          <button id="clearEventsBtn" style="flex: 1; background: #6c757d">
            æ¸…ç©ºæ—¥å¿—
          </button>
        </div>
        <div id="eventStatus" class="info-box" style="background: #e9ecef">
          <p>
            <strong>ç›‘å¬çŠ¶æ€:</strong> <span id="listenStatus">æœªå¼€å§‹</span>
          </p>
          <p><strong>æ¥æ”¶äº‹ä»¶æ•°:</strong> <span id="eventCount">0</span></p>
        </div>
        <div
          id="eventLogs"
          style="margin-top: 15px; max-height: 300px; overflow-y: auto"
        >
          <!-- äº‹ä»¶æ—¥å¿—å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
        </div>
      </div>
    </div>

    <!-- å¼•å…¥ jQuery å’Œ ethers.js -->
    <script src="./node_modules/jquery/dist/jquery.min.js"></script>
    <script src="./node_modules/ethers/dist/ethers.umd.min.js"></script>
    <script>
      // å…¨å±€å˜é‡
      let provider;
      let signer;
      let contract;
      let userAddress;
      let eventListener = null;
      let eventCount = 0;
      let isListening = false;
      let contractData = null; // å­˜å‚¨ä» InfoContract.json åŠ è½½çš„æ•°æ®

      // ç½‘ç»œé…ç½®ä¿¡æ¯
      const networkConfigs = {
        '0x539': {
          chainId: '0x539',
          chainName: 'Local Testnet (Ganache)',
          nativeCurrency: { name: 'Ether', symbol: 'ETH', decimals: 18 },
          rpcUrls: ['http://127.0.0.1:7545'],
          blockExplorerUrls: [],
        },
        '0x1': {
          chainId: '0x1',
          chainName: 'Ethereum Mainnet',
          nativeCurrency: { name: 'Ether', symbol: 'ETH', decimals: 18 },
          rpcUrls: ['https://mainnet.infura.io/v3/'],
          blockExplorerUrls: ['https://etherscan.io'],
        },
        '0xaa36a7': {
          chainId: '0xaa36a7',
          chainName: 'Sepolia Testnet',
          nativeCurrency: {
            name: 'Sepolia Ether',
            symbol: 'ETH',
            decimals: 18,
          },
          rpcUrls: ['https://sepolia.infura.io/v3/'],
          blockExplorerUrls: ['https://sepolia.etherscan.io'],
        },
        '0x5': {
          chainId: '0x5',
          chainName: 'Goerli Testnet',
          nativeCurrency: { name: 'Goerli Ether', symbol: 'ETH', decimals: 18 },
          rpcUrls: ['https://goerli.infura.io/v3/'],
          blockExplorerUrls: ['https://goerli.etherscan.io'],
        },
        '0x38': {
          chainId: '0x38',
          chainName: 'BSC Mainnet',
          nativeCurrency: { name: 'BNB', symbol: 'BNB', decimals: 18 },
          rpcUrls: ['https://bsc-dataseed1.binance.org'],
          blockExplorerUrls: ['https://bscscan.com'],
        },
        '0x61': {
          chainId: '0x61',
          chainName: 'BSC Testnet',
          nativeCurrency: { name: 'tBNB', symbol: 'tBNB', decimals: 18 },
          rpcUrls: ['https://data-seed-prebsc-1-s1.binance.org:8545'],
          blockExplorerUrls: ['https://testnet.bscscan.com'],
        },
        '0x89': {
          chainId: '0x89',
          chainName: 'Polygon Mainnet',
          nativeCurrency: { name: 'MATIC', symbol: 'MATIC', decimals: 18 },
          rpcUrls: ['https://polygon-rpc.com'],
          blockExplorerUrls: ['https://polygonscan.com'],
        },
        '0x13882': {
          chainId: '0x13882',
          chainName: 'Polygon Amoy Testnet',
          nativeCurrency: { name: 'MATIC', symbol: 'MATIC', decimals: 18 },
          rpcUrls: ['https://rpc-amoy.polygon.technology'],
          blockExplorerUrls: ['https://amoy.polygonscan.com'],
        },
      };

      // åŠ è½½åˆçº¦ JSON æ•°æ®
      async function loadContractJson() {
        try {
          const response = await fetch('./build/InfoContract.json');
          if (!response.ok) {
            throw new Error('æ— æ³•åŠ è½½ InfoContract.json');
          }
          contractData = await response.json();
          console.log('åˆçº¦æ•°æ®å·²åŠ è½½:', contractData);
          return contractData;
        } catch (error) {
          console.error('åŠ è½½åˆçº¦ JSON å¤±è´¥:', error);
          throw error;
        }
      }

      // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½åˆçº¦ JSON
      $(document).ready(async function () {
        try {
          await loadContractJson();
          showStatus('ğŸ“„ åˆçº¦é…ç½®æ–‡ä»¶å·²åŠ è½½', 'success');
        } catch (error) {
          showStatus('âŒ åŠ è½½åˆçº¦é…ç½®å¤±è´¥: ' + error.message, 'error');
        }
      });

      // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
      function showStatus(message, type = 'info') {
        $('#status')
          .removeClass('hidden success error info')
          .addClass(type)
          .text(message);
        setTimeout(() => {
          $('#status').addClass('hidden');
        }, 5000);
      }

      // è¿æ¥ MetaMask
      $('#connectBtn').click(async function () {
        try {
          if (typeof window.ethereum === 'undefined') {
            showStatus('âŒ è¯·å…ˆå®‰è£… MetaMask!', 'error');
            return;
          }

          $(this).prop('disabled', true).text('è¿æ¥ä¸­...');

          // è¯·æ±‚è´¦æˆ·è®¿é—®
          const accounts = await window.ethereum.request({
            method: 'eth_requestAccounts',
          });

          userAddress = accounts[0];

          // åˆ›å»º provider å’Œ signer
          provider = new ethers.BrowserProvider(window.ethereum);
          signer = await provider.getSigner();

          // è·å–ç½‘ç»œä¿¡æ¯
          let network = await provider.getNetwork();
          const targetChainId = '0x539'; // æœ¬åœ°æµ‹è¯•ç½‘

          // æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ‡æ¢åˆ°æœ¬åœ°æµ‹è¯•ç½‘
          if (network.chainId.toString(16) !== targetChainId.substring(2)) {
            showStatus('ğŸ”„ æ­£åœ¨åˆ‡æ¢åˆ°æœ¬åœ°æµ‹è¯•ç½‘...', 'info');

            try {
              // å°è¯•åˆ‡æ¢åˆ°æœ¬åœ°æµ‹è¯•ç½‘
              await window.ethereum.request({
                method: 'wallet_switchEthereumChain',
                params: [{ chainId: targetChainId }],
              });
            } catch (switchError) {
              // å¦‚æœç½‘ç»œä¸å­˜åœ¨ï¼Œå°è¯•æ·»åŠ ç½‘ç»œ
              if (switchError.code === 4902) {
                const networkConfig = networkConfigs[targetChainId];
                await window.ethereum.request({
                  method: 'wallet_addEthereumChain',
                  params: [networkConfig],
                });
              } else {
                throw switchError;
              }
            }

            // é‡æ–°è·å–ç½‘ç»œä¿¡æ¯
            provider = new ethers.BrowserProvider(window.ethereum);
            signer = await provider.getSigner();
            network = await provider.getNetwork();
          }

          const balance = await provider.getBalance(userAddress);

          // æ˜¾ç¤ºè´¦æˆ·ä¿¡æ¯
          $('#accountAddress').text(userAddress);
          $('#networkName').text(
            network.name == 'unknown'
              ? 'LocalHost'
              : network.name + ' (Chain ID: ' + network.chainId + ')'
          );
          $('#balance').text(ethers.formatEther(balance));
          $('#accountInfo').removeClass('hidden');
          $('#networkSwitch').removeClass('hidden');

          $(this).text('âœ… å·²è¿æ¥').css('background', '#28a745');
          showStatus('âœ… é’±åŒ…è¿æ¥æˆåŠŸ!', 'success');

          // è‡ªåŠ¨åŠ è½½åˆçº¦
          setTimeout(async () => {
            await loadContract();
          }, 500);
        } catch (error) {
          console.error(error);
          showStatus('âŒ è¿æ¥å¤±è´¥: ' + error.message, 'error');
          $(this).prop('disabled', false).text('è¿æ¥ MetaMask');
        }
      });

      // è‡ªåŠ¨åŠ è½½åˆçº¦å‡½æ•°
      async function loadContract() {
        try {
          if (!contractData) {
            showStatus('âŒ åˆçº¦é…ç½®æ–‡ä»¶æœªåŠ è½½!', 'error');
            return false;
          }

          if (!signer) {
            showStatus('âŒ è¯·å…ˆè¿æ¥é’±åŒ…!', 'error');
            return false;
          }

          // è·å–å½“å‰ç½‘ç»œ
          const network = await provider.getNetwork();
          const chainId = network.chainId.toString();

          console.log('å½“å‰ç½‘ç»œ Chain ID:', chainId);

          // ä» contractData.networks ä¸­è·å–åˆçº¦åœ°å€
          const networkInfo = contractData.networks[5777];

          if (!networkInfo) {
            throw new Error( mmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmm
              `åˆçº¦æœªéƒ¨ç½²åœ¨å½“å‰ç½‘ç»œ (Chain ID: ${chainId})ã€‚å¯ç”¨ç½‘ç»œ: ${Object.keys(
                contractData.networks
              ).join(', ')}`
            );
          }

          const contractAddress = networkInfo.address;
          const contractABI = contractData.abi;

          console.log('åˆçº¦åœ°å€:', contractAddress);
          console.log('åˆçº¦ ABI:', contractABI);

          // åˆ›å»ºåˆçº¦å®ä¾‹
          contract = new ethers.Contract(contractAddress, contractABI, signer);

          // æµ‹è¯•åˆçº¦æ˜¯å¦æœ‰æ•ˆ
          await contract.sayHi();

          showStatus('âœ… åˆçº¦å·²è‡ªåŠ¨åŠ è½½!', 'success');
          return true;
        } catch (error) {
          console.error('åˆçº¦åŠ è½½å¤±è´¥:', error);
          showStatus('âŒ åˆçº¦åŠ è½½å¤±è´¥: ' + error.message, 'error');
          return false;
        }
      }

      // è°ƒç”¨ sayHi
      $('#sayHiBtn').click(async function () {
        try {
          if (!contract) {
            showStatus('âŒ è¯·å…ˆåŠ è½½åˆçº¦!', 'error');
            return;
          }

          $(this)
            .prop('disabled', true)
            .html('è°ƒç”¨ä¸­... <span class="loading"></span>');

          const result = await contract.sayHi();

          $('#readResultText').html(
            `<strong>sayHi() è¿”å›:</strong><br>${result}`
          );
          $('#readResult').removeClass('hidden');

          $(this).prop('disabled', false).text('è°ƒç”¨ sayHi()');
          showStatus('âœ… è°ƒç”¨æˆåŠŸ!', 'success');
        } catch (error) {
          console.error(error);
          showStatus('âŒ è°ƒç”¨å¤±è´¥: ' + error.message, 'error');
          $(this).prop('disabled', false).text('è°ƒç”¨ sayHi()');
        }
      });

      // è°ƒç”¨ getInfo
      $('#getInfoBtn').click(async function () {
        try {
          if (!contract) {
            showStatus('âŒ è¯·å…ˆåŠ è½½åˆçº¦!', 'error');
            return;
          }

          $(this)
            .prop('disabled', true)
            .html('è°ƒç”¨ä¸­... <span class="loading"></span>');

          const result = await contract.getInfo();

          $('#readResultText').html(`
            <strong>getInfo() è¿”å›:</strong><br>
            å§“å: ${result[0]}<br>
            å¹´é¾„: ${result[1].toString()}
          `);
          $('#readResult').removeClass('hidden');

          $(this).prop('disabled', false).text('è°ƒç”¨ getInfo()');
          showStatus('âœ… è°ƒç”¨æˆåŠŸ!', 'success');
        } catch (error) {
          console.error(error);
          showStatus('âŒ è°ƒç”¨å¤±è´¥: ' + error.message, 'error');
          $(this).prop('disabled', false).text('è°ƒç”¨ getInfo()');
        }
      });

      // è°ƒç”¨ setInfo
      $('#setInfoBtn').click(async function () {
        try {
          if (!contract) {
            showStatus('âŒ è¯·å…ˆåŠ è½½åˆçº¦!', 'error');
            return;
          }

          const name = $('#nameInput').val().trim();
          const age = $('#ageInput').val().trim();

          if (!name || !age) {
            showStatus('âŒ è¯·è¾“å…¥å§“åå’Œå¹´é¾„!', 'error');
            return;
          }

          $(this)
            .prop('disabled', true)
            .html('äº¤æ˜“ä¸­... <span class="loading"></span>');

          // å‘é€äº¤æ˜“
          const tx = await contract.setInfo(name, age);

          $('#txResultText').html(`
            <strong>â³ äº¤æ˜“å·²å‘é€ï¼Œç­‰å¾…ç¡®è®¤...</strong><br>
            äº¤æ˜“å“ˆå¸Œ: ${tx.hash}
          `);
          $('#txResult').removeClass('hidden');

          // ç­‰å¾…äº¤æ˜“ç¡®è®¤
          const receipt = await tx.wait();

          $('#txResultText').html(`
            <strong>âœ… äº¤æ˜“æˆåŠŸ!</strong><br>
            äº¤æ˜“å“ˆå¸Œ: ${receipt.hash}<br>
          `);

          $(this).prop('disabled', false).text('è°ƒç”¨ setInfo()');
          showStatus('âœ… äº¤æ˜“æˆåŠŸ!', 'success');

          // æ¸…ç©ºè¾“å…¥æ¡†
          $('#nameInput').val('');
          $('#ageInput').val('');
        } catch (error) {
          console.error(error);
          showStatus('âŒ äº¤æ˜“å¤±è´¥: ' + error.message, 'error');
          $(this).prop('disabled', false).text('è°ƒç”¨ setInfo()');
        }
      });

      // æ·»åŠ äº‹ä»¶æ—¥å¿—åˆ°é¡µé¢
      function addEventLog(eventData) {
        eventCount++;
        $('#eventCount').text(eventCount);

        const timestamp = new Date().toLocaleString('zh-CN');
        const eventHtml = `
          <div class="event-item">
            <div class="event-header">
              <span>ğŸ”” Instructor äº‹ä»¶</span>
              <span class="event-time">${timestamp}</span>
            </div>
            <div class="event-data">
              ğŸ‘¤ å§“å: ${eventData.name}
            </div>
            <div class="event-data">
              ğŸ‚ å¹´é¾„: ${eventData.age.toString()}
            </div>
            <div class="event-block">
              ğŸ“¦ åŒºå—å·: ${eventData.blockNumber}
            </div>
            <div class="event-block">
              ğŸ”— äº¤æ˜“å“ˆå¸Œ: ${eventData.transactionHash}
            </div>
          </div>
        `;

        $('#eventLogs').prepend(eventHtml);
        showStatus('ğŸ”” æ”¶åˆ°æ–°äº‹ä»¶!', 'success');
      }

      // å¼€å§‹ç›‘å¬äº‹ä»¶
      $('#startListenBtn').click(async function () {
        try {
          if (!contract) {
            showStatus('âŒ è¯·å…ˆåŠ è½½åˆçº¦!', 'error');
            return;
          }

          if (isListening) {
            showStatus('âš ï¸ å·²ç»åœ¨ç›‘å¬ä¸­!', 'info');
            return;
          }

          $(this).prop('disabled', true);

          // ç›‘å¬ Instructor äº‹ä»¶
          contract.on('Instructor', (name, age, event) => {
            console.log('æ”¶åˆ°äº‹ä»¶:', { name, age, event });

            // è·å–äº‹ä»¶è¯¦æƒ…
            event.getBlock().then((block) => {
              addEventLog({
                name: name,
                age: age,
                blockNumber: event.blockNumber,
                transactionHash: event.transactionHash,
                blockTime: new Date(block.timestamp * 1000).toLocaleString(
                  'zh-CN'
                ),
              });
            });
          });

          isListening = true;
          $('#listenStatus').text('ğŸŸ¢ ç›‘å¬ä¸­...').addClass('listening');
          showStatus('âœ… å¼€å§‹ç›‘å¬äº‹ä»¶!', 'success');
        } catch (error) {
          console.error(error);
          showStatus('âŒ å¯åŠ¨ç›‘å¬å¤±è´¥: ' + error.message, 'error');
          $(this).prop('disabled', false);
        }
      });

      // åœæ­¢ç›‘å¬äº‹ä»¶
      $('#stopListenBtn').click(function () {
        if (!contract) {
          showStatus('âŒ è¯·å…ˆåŠ è½½åˆçº¦!', 'error');
          return;
        }

        if (!isListening) {
          showStatus('âš ï¸ æœªåœ¨ç›‘å¬ä¸­!', 'info');
          return;
        }

        // ç§»é™¤æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨
        contract.removeAllListeners('Instructor');

        isListening = false;
        $('#listenStatus').text('ğŸ”´ å·²åœæ­¢').removeClass('listening');
        $('#startListenBtn').prop('disabled', false);
        showStatus('â¹ï¸ å·²åœæ­¢ç›‘å¬', 'info');
      });

      // æ¸…ç©ºäº‹ä»¶æ—¥å¿—
      $('#clearEventsBtn').click(function () {
        $('#eventLogs').empty();
        eventCount = 0;
        $('#eventCount').text('0');
        showStatus('ğŸ—‘ï¸ å·²æ¸…ç©ºæ—¥å¿—', 'info');
      });

      // åˆ‡æ¢ç½‘ç»œ
      $('#switchNetworkBtn').click(async function () {
        try {
          const selectedChainId = $('#networkSelector').val();

          if (!selectedChainId) {
            showStatus('âŒ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç½‘ç»œ!', 'error');
            return;
          }

          if (typeof window.ethereum === 'undefined') {
            showStatus('âŒ è¯·å…ˆå®‰è£… MetaMask!', 'error');
            return;
          }

          $(this).prop('disabled', true).text('åˆ‡æ¢ä¸­...');

          try {
            // å°è¯•åˆ‡æ¢åˆ°ç›®æ ‡ç½‘ç»œ
            await window.ethereum.request({
              method: 'wallet_switchEthereumChain',
              params: [{ chainId: selectedChainId }],
            });

            showStatus('âœ… ç½‘ç»œåˆ‡æ¢æˆåŠŸ!', 'success');

            // åˆ‡æ¢æˆåŠŸååˆ·æ–°é¡µé¢ä¿¡æ¯
            setTimeout(() => {
              location.reload();
            }, 1000);
          } catch (switchError) {
            // å¦‚æœç½‘ç»œä¸å­˜åœ¨ï¼Œå°è¯•æ·»åŠ ç½‘ç»œ
            if (switchError.code === 4902) {
              try {
                const networkConfig = networkConfigs[selectedChainId];

                await window.ethereum.request({
                  method: 'wallet_addEthereumChain',
                  params: [networkConfig],
                });

                showStatus('âœ… ç½‘ç»œæ·»åŠ å¹¶åˆ‡æ¢æˆåŠŸ!', 'success');

                setTimeout(() => {
                  location.reload();
                }, 1000);
              } catch (addError) {
                console.error('æ·»åŠ ç½‘ç»œå¤±è´¥:', addError);
                showStatus('âŒ æ·»åŠ ç½‘ç»œå¤±è´¥: ' + addError.message, 'error');
              }
            } else {
              console.error('åˆ‡æ¢ç½‘ç»œå¤±è´¥:', switchError);
              showStatus('âŒ åˆ‡æ¢ç½‘ç»œå¤±è´¥: ' + switchError.message, 'error');
            }
          }

          $(this).prop('disabled', false).text('åˆ‡æ¢åˆ°é€‰ä¸­ç½‘ç»œ');
        } catch (error) {
          console.error('ç½‘ç»œåˆ‡æ¢é”™è¯¯:', error);
          showStatus('âŒ æ“ä½œå¤±è´¥: ' + error.message, 'error');
          $(this).prop('disabled', false).text('åˆ‡æ¢åˆ°é€‰ä¸­ç½‘ç»œ');
        }
      });

      // ç›‘å¬è´¦æˆ·åˆ‡æ¢
      if (window.ethereum) {
        window.ethereum.on('accountsChanged', function (accounts) {
          if (accounts.length === 0) {
            showStatus('âŒ é’±åŒ…å·²æ–­å¼€è¿æ¥', 'error');
            location.reload();
          } else {
            location.reload();
          }
        });

        window.ethereum.on('chainChanged', function () {
          location.reload();
        });
      }
    </script>
  </body>
</html>
